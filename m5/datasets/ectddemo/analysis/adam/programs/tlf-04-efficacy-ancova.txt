from datetime import datetime
import polars as pl
import rtflite as rtf

from demo001 import find_project_root, load_adam_dataset
from demo001.efficacy import (
    prepare_locf_data,
    calculate_descriptive_stats,
    perform_ancova,
    format_efficacy_table,
    format_comparison_table,
)

pl.Config.set_tbl_rows(5)

project_root = find_project_root()
adsl = load_adam_dataset("adsl", project_root)
adlbc = load_adam_dataset("adlbc", project_root)
treatments = ["Placebo", "Xanomeline Low Dose", "Xanomeline High Dose"]

lab_vars = adlbc.select(
    ["USUBJID", "PARAMCD", "PARAM", "AVISIT", "AVISITN", "AVAL", "BASE", "CHG"]
)
lab_vars

gluc_visits = (
    adlbc.filter(pl.col("PARAMCD") == "GLUC")
    .select("AVISIT", "AVISITN")
    .unique()
    .sort("AVISITN")
)
gluc_visits

adlbc_clean = adlbc.with_columns(
    [
        pl.col(c).cast(str).str.strip_chars()
        for c in ["USUBJID", "PARAMCD", "AVISIT", "TRTP"]
    ]
)

adsl_eff = adsl.filter(pl.col("EFFFL") == "Y").select(["USUBJID"])
adsl_eff.height

adlbc_eff = adlbc_clean.join(adsl_eff, on="USUBJID", how="inner")
adlbc_eff.height

gluc_availability = (
    adlbc_eff.filter(pl.col("PARAMCD") == "GLUC")
    .group_by(["TRTP", "AVISIT"])
    .agg(n_subjects=pl.col("USUBJID").n_unique())
    .sort(["TRTP", "AVISIT"])
)
gluc_availability

gluc_data = prepare_locf_data(
    adlbc=adlbc_eff, adsl_eff=adsl_eff, param="GLUC", endpoint_week=24
)

gluc_data.height
gluc_data

locf_summary = (
    gluc_data.group_by(["TRTP", "Last_Visit"])
    .agg(n_subjects=pl.len())
    .sort(["TRTP", "Last_Visit"])
)
locf_summary

desc_stats = calculate_descriptive_stats(gluc_data, treatments)

desc_df = pl.DataFrame(desc_stats)
desc_df

ancova_results = perform_ancova(gluc_data, treatments)

model = ancova_results["model"]
ls_means = ancova_results["ls_means"]
comparisons = ancova_results["comparisons"]

print(f"R-squared: {model.rsquared:.4f}")
print(f"F-statistic: {model.fvalue:.2f}, p-value: {model.f_pvalue:.4f}")

ls_means_df = pl.DataFrame(ls_means)
ls_means_df

comparison_df = pl.DataFrame(comparisons)
comparison_df

tbl1 = format_efficacy_table(desc_stats, ls_means)
tbl1

tbl2 = format_comparison_table(comparisons)
tbl2

doc_ancova = rtf.RTFDocument(
    df=[tbl1, tbl2],
    rtf_title=rtf.RTFTitle(
        text=[
            "Analysis of Covariance (ANCOVA) of Change from Baseline in",
            "Fasting Glucose (mmol/L) at Week 24 (LOCF)",
            "Efficacy Analysis Population",
        ]
    ),
    rtf_column_header=[
        # Header for descriptive statistics table
        [
            rtf.RTFColumnHeader(
                text=["", "Baseline", "Week 24 (LOCF)", "Change from Baseline", ""],
                col_rel_width=[3, 2, 2, 3, 2],
                text_justification=["l", "c", "c", "c", "c"],
                text_format="b",
            ),
            rtf.RTFColumnHeader(
                text=[
                    "Treatment Group",
                    "N",
                    "Mean (SD)",
                    "N",
                    "Mean (SD)",
                    "N",
                    "Mean (SD)",
                    "LS Mean (95% CI){^a}",
                ],
                col_rel_width=[3, 0.7, 1.3, 0.7, 1.3, 0.7, 1.3, 2],
                text_justification=["l"] + ["c"] * 7,
                border_bottom="single",
                text_format="b",
            ),
        ],
        # Header for pairwise comparisons table
        [
            rtf.RTFColumnHeader(
                text=[
                    "Pairwise Comparison",
                    "Difference in LS Mean (95% CI){^a}",
                    "p-Value{^b}",
                ],
                col_rel_width=[5, 4, 2],
                text_justification=["l", "c", "c"],
                text_format="b",
                border_bottom="single",
            )
        ],
    ],
    rtf_body=[
        # Body for descriptive statistics
        rtf.RTFBody(
            col_rel_width=[3, 0.7, 1.3, 0.7, 1.3, 0.7, 1.3, 2],
            text_justification=["l"] + ["c"] * 7,
        ),
        # Body for pairwise comparisons
        rtf.RTFBody(col_rel_width=[5, 4, 2], text_justification=["l", "c", "c"]),
    ],
    rtf_footnote=rtf.RTFFootnote(
        text=[
            "{^a}LS means and differences in LS means are based on an ANCOVA model with treatment and baseline glucose as covariates.",
            f"{{^b}}p-values are from the ANCOVA model testing treatment effects (overall F-test p-value: {model.f_pvalue:.4f}).",
            "LOCF (Last Observation Carried Forward) approach is used for missing Week 24 values.",
            "ANCOVA = Analysis of Covariance; CI = Confidence Interval; LS = Least Squares; SD = Standard Deviation",
        ]
    ),
    rtf_source=rtf.RTFSource(
        text=[
            "Source: ADLBC Analysis Dataset",
            f"Analysis conducted: {datetime.now().strftime('%d%b%Y').upper()}",
            "Statistical software: Python (statsmodels)",
        ]
    ),
)

doc_ancova.write_rtf(project_root / "output" / "tlf_efficacy_ancova.rtf")
